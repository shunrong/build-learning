# å¹¶è¡Œæ„å»ºï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU

## ğŸ“– ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œæ„å»ºï¼Ÿ

### Node.js çš„å•çº¿ç¨‹é™åˆ¶

```
ä¼ ç»Ÿ Webpack æ„å»ºï¼š

å•çº¿ç¨‹ â†’  æ¨¡å—1 â†’ æ¨¡å—2 â†’ æ¨¡å—3 â†’ ... â†’ æ¨¡å—3000
           â†“      â†“      â†“              â†“
          200ms  200ms  200ms         200ms

æ€»è€—æ—¶ï¼š3000 Ã— 200ms = 600s (10åˆ†é’Ÿ) ğŸ˜«


å¹¶è¡Œæ„å»ºï¼ˆ4æ ¸CPUï¼‰ï¼š

çº¿ç¨‹1 â†’  æ¨¡å—1 â†’ æ¨¡å—5 â†’ æ¨¡å—9  â†’ ...
çº¿ç¨‹2 â†’  æ¨¡å—2 â†’ æ¨¡å—6 â†’ æ¨¡å—10 â†’ ...
çº¿ç¨‹3 â†’  æ¨¡å—3 â†’ æ¨¡å—7 â†’ æ¨¡å—11 â†’ ...
çº¿ç¨‹4 â†’  æ¨¡å—4 â†’ æ¨¡å—8 â†’ æ¨¡å—12 â†’ ...

æ€»è€—æ—¶ï¼š3000 Ã— 200ms Ã· 4 = 150s (2.5åˆ†é’Ÿ) âš¡ï¸
```

**ç†è®ºåŠ é€Ÿæ¯”** = CPU æ ¸å¿ƒæ•°

**å®é™…åŠ é€Ÿæ¯”** = 40-60%ï¼ˆè€ƒè™‘çº¿ç¨‹å¼€é”€ï¼‰

---

## ğŸš€ thread-loader â­ï¸â­ï¸â­ï¸

### ä»€ä¹ˆæ˜¯ thread-loaderï¼Ÿ

å°†è€—æ—¶çš„ loader æ”¾åœ¨**ç‹¬ç«‹çš„ Worker Pool** ä¸­è¿è¡Œã€‚

**åŸç†**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Webpack Core                      â”‚
â”‚    â†“                               â”‚
â”‚  å‘é€ä»»åŠ¡åˆ° Worker Pool             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Worker Poolï¼ˆå¤šçº¿ç¨‹ï¼‰           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Worker 1: babel-loader (æ¨¡å—1)    â”‚
â”‚  Worker 2: babel-loader (æ¨¡å—2)    â”‚
â”‚  Worker 3: babel-loader (æ¨¡å—3)    â”‚
â”‚  Worker 4: babel-loader (æ¨¡å—4)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å¹¶è¡Œå¤„ç†ï¼Œè¿”å›ç»“æœ
```

---

### å®‰è£…

```bash
npm install --save-dev thread-loader
```

---

### åŸºç¡€é…ç½®

```javascript
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          'thread-loader',  // â­ï¸ æ”¾åœ¨æœ€å‰é¢
          'babel-loader'
        ],
        exclude: /node_modules/
      }
    ]
  }
};
```

**å…³é”®ç‚¹**ï¼š
- âœ… thread-loader è¦æ”¾åœ¨**æœ€å‰é¢**ï¼ˆloader ä»å³åˆ°å·¦æ‰§è¡Œï¼‰
- âœ… åªç”¨äº**è€—æ—¶çš„ loader**ï¼ˆå¦‚ babel-loader, ts-loaderï¼‰

---

### å®Œæ•´é…ç½®ï¼ˆè¿›é˜¶ï¼‰

```javascript
// webpack.config.js
const os = require('os');

module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: 'thread-loader',
            options: {
              // Worker æ•°é‡ï¼ˆé»˜è®¤ï¼šCPU æ ¸å¿ƒæ•° - 1ï¼‰
              workers: os.cpus().length - 1,
              
              // Worker å¹¶è¡Œä»»åŠ¡æ•°ï¼ˆé»˜è®¤ï¼š20ï¼‰
              workerParallelJobs: 50,
              
              // Worker è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š500msï¼‰
              poolTimeout: 2000,
              
              // æ± å­çš„å¤§å°ï¼ˆé»˜è®¤ï¼š500ï¼‰
              poolParallelJobs: 200,
              
              // æ± å­çš„åç§°ï¼ˆç”¨äºä¸åŒè§„åˆ™å…±äº«æ± å­ï¼‰
              name: 'js-pool'
            }
          },
          'babel-loader'
        ],
        exclude: /node_modules/
      }
    ]
  }
};
```

---

### é¢„çƒ­ Worker Pool

Worker å¯åŠ¨æœ‰å¼€é”€ï¼ˆ~600msï¼‰ï¼Œå¯ä»¥æå‰é¢„çƒ­ï¼š

```javascript
// webpack.config.js
const threadLoader = require('thread-loader');

// â­ï¸ é¢„çƒ­ Worker Pool
threadLoader.warmup(
  {
    workers: os.cpus().length - 1,
    poolTimeout: 2000,
  },
  [
    'babel-loader',
    // '@babel/preset-env',
  ]
);

module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: ['thread-loader', 'babel-loader']
      }
    ]
  }
};
```

---

### ä½•æ—¶ä½¿ç”¨ thread-loaderï¼Ÿ

#### âœ… é€‚åˆçš„åœºæ™¯

```
1. å¤§å‹é¡¹ç›®
   â””â”€ æ¨¡å—æ•°é‡ > 1000

2. è€—æ—¶çš„ Loader
   â””â”€ babel-loader (JS è½¬æ¢)
   â””â”€ ts-loader (TS ç¼–è¯‘)
   â””â”€ sass-loader (Sass ç¼–è¯‘)

3. æ„å»ºæ—¶é—´ > 60s
   â””â”€ æœ‰è¶³å¤Ÿçš„ä¼˜åŒ–ç©ºé—´
```

#### âŒ ä¸é€‚åˆçš„åœºæ™¯

```
1. å°å‹é¡¹ç›®
   â””â”€ æ¨¡å—æ•°é‡ < 500
   â””â”€ Worker å¯åŠ¨å¼€é”€ > æ”¶ç›Š

2. å¿«é€Ÿçš„ Loader
   â””â”€ å•ä¸ªæ¨¡å—å¤„ç†æ—¶é—´ < 50ms
   â””â”€ çº¿ç¨‹é€šä¿¡å¼€é”€ > æ”¶ç›Š

3. å¼€å‘ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
   â””â”€ çƒ­æ›´æ–°æ—¶ï¼ŒWorker å¯åŠ¨æœ‰å»¶è¿Ÿ
   â””â”€ å¯ä»¥åªåœ¨ç”Ÿäº§æ„å»ºæ—¶ä½¿ç”¨
```

---

### å®æˆ˜æ•ˆæœ

#### é¡¹ç›®èƒŒæ™¯

```
â”œâ”€ æ¨¡å—æ•°é‡ï¼š~2500
â”œâ”€ æŠ€æœ¯æ ˆï¼šReact + Babel
â”œâ”€ ä¸»è¦ç“¶é¢ˆï¼šbabel-loader
â””â”€ å•çº¿ç¨‹æ„å»ºæ—¶é—´ï¼š120s
```

#### é…ç½®å¯¹æ¯”

**é…ç½® 1ï¼šå•çº¿ç¨‹**

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: 'babel-loader'
      }
    ]
  }
};
```

**é…ç½® 2ï¼šå¤šçº¿ç¨‹ï¼ˆ4 æ ¸ CPUï¼‰**

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: 'thread-loader',
            options: {
              workers: 3  // CPU æ ¸å¿ƒæ•° - 1
            }
          },
          'babel-loader'
        ]
      }
    ]
  }
};
```

#### æ•°æ®å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åœºæ™¯         â”‚  å•çº¿ç¨‹   â”‚ å¤šçº¿ç¨‹   â”‚  æå‡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¦–æ¬¡æ„å»º         â”‚  120s    â”‚   70s    â”‚  -42%   â”‚
â”‚ äºŒæ¬¡æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰â”‚  120s    â”‚   70s    â”‚  -42%   â”‚
â”‚ äºŒæ¬¡æ„å»ºï¼ˆæœ‰ç¼“å­˜ï¼‰â”‚   15s    â”‚   15s    â”‚   0%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼š
  â”œâ”€ æ— ç¼“å­˜æ—¶ï¼šæå‡ 40-60% âš¡ï¸âš¡ï¸
  â”œâ”€ æœ‰ç¼“å­˜æ—¶ï¼šæ— æå‡ï¼ˆç¼“å­˜å·²ç»è¶³å¤Ÿå¿«ï¼‰
  â””â”€ å»ºè®®ï¼šç¼“å­˜ + å¹¶è¡Œ ç»“åˆä½¿ç”¨
```

---

## âš™ï¸ TerserPlugin å¹¶è¡Œå‹ç¼© â­ï¸â­ï¸

### ä»€ä¹ˆæ˜¯ TerserPluginï¼Ÿ

Webpack 5 å†…ç½®çš„ JS å‹ç¼©æ’ä»¶ï¼ˆåŸºäº Terserï¼‰ã€‚

**å‹ç¼©è¿‡ç¨‹å¾ˆè€—æ—¶**ï¼š

```
ç”Ÿäº§æ„å»ºï¼š
  â”œâ”€ ç¼–è¯‘é˜¶æ®µï¼š60s
  â””â”€ å‹ç¼©é˜¶æ®µï¼š40s  â† âš ï¸ å æ¯” 40%
```

---

### å¯ç”¨å¹¶è¡Œå‹ç¼©

```javascript
// webpack.config.js
const TerserPlugin = require('terser-webpack-plugin');

module.exports = {
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        parallel: true,  // â­ï¸ å¯ç”¨å¹¶è¡Œå‹ç¼©ï¼ˆé»˜è®¤ä¸º trueï¼‰
        // parallel: 4,  // æŒ‡å®šå¹¶è¡Œæ•°é‡
        
        terserOptions: {
          compress: {
            drop_console: true,  // ç§»é™¤ console
          }
        }
      })
    ]
  }
};
```

**é»˜è®¤è¡Œä¸º**ï¼š
- Webpack 5ï¼š`parallel: true`ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- å¹¶è¡Œæ•°é‡ï¼š`os.cpus().length - 1`

---

### å®æˆ˜æ•ˆæœ

```
é¡¹ç›®èƒŒæ™¯ï¼š
  â””â”€ æ‰“åŒ…ä½“ç§¯ï¼š5 MBï¼ˆæœªå‹ç¼©ï¼‰

é…ç½®å¯¹æ¯”ï¼š

å•çº¿ç¨‹å‹ç¼©ï¼š
  â””â”€ å‹ç¼©æ—¶é—´ï¼š45s

å¹¶è¡Œå‹ç¼©ï¼ˆ4æ ¸ï¼‰ï¼š
  â””â”€ å‹ç¼©æ—¶é—´ï¼š28sï¼ˆ-38%ï¼‰âš¡ï¸

ç»“è®ºï¼š
  â””â”€ å‹ç¼©é˜¶æ®µæå‡ 30-50%
```

---

## ğŸ”„ HappyPackï¼ˆå·²åºŸå¼ƒï¼‰

### äº†è§£å†å²

**HappyPack** æ˜¯ Webpack 3/4 æ—¶ä»£çš„å¹¶è¡Œæ„å»ºæ–¹æ¡ˆã€‚

**ä¸ºä»€ä¹ˆåºŸå¼ƒ**ï¼Ÿ
1. thread-loader æ˜¯å®˜æ–¹æ¨èæ–¹æ¡ˆ
2. ç»´æŠ¤ä¸æ´»è·ƒï¼ˆæœ€åæ›´æ–°ï¼š2019å¹´ï¼‰
3. Webpack 5 æ€§èƒ½å·²å¤§å¹…æå‡

**ä»…ä¾›å‚è€ƒ**ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰ã€‚

---

## ğŸ“Š å¹¶è¡Œä¼˜åŒ–ç­–ç•¥

### å®Œæ•´é…ç½®ï¼ˆç”Ÿäº§çº§ï¼‰

```javascript
// webpack.config.js
const os = require('os');
const threadLoader = require('thread-loader');
const TerserPlugin = require('terser-webpack-plugin');

// é¢„çƒ­ Worker Pool
threadLoader.warmup(
  {
    workers: os.cpus().length - 1,
  },
  ['babel-loader']
);

module.exports = (env, argv) => {
  const isProd = argv.mode === 'production';
  
  return {
    module: {
      rules: [
        {
          test: /\.js$/,
          use: [
            // âš ï¸ åªåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ thread-loader
            isProd && {
              loader: 'thread-loader',
              options: {
                workers: os.cpus().length - 1,
                workerParallelJobs: 50,
              }
            },
            'babel-loader'
          ].filter(Boolean),
          exclude: /node_modules/
        }
      ]
    },
    
    optimization: {
      minimize: isProd,
      minimizer: [
        new TerserPlugin({
          parallel: true,  // å¹¶è¡Œå‹ç¼©
          terserOptions: {
            compress: {
              drop_console: true,
            }
          }
        })
      ]
    }
  };
};
```

---

### å¼€å‘ vs ç”Ÿäº§

| é…ç½® | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| **thread-loader** | âŒ ä¸æ¨èï¼ˆçƒ­æ›´æ–°æœ‰å»¶è¿Ÿï¼‰ | âœ… æ¨è |
| **å¹¶è¡Œå‹ç¼©** | âŒ ä¸éœ€è¦ï¼ˆä¸å‹ç¼©ï¼‰ | âœ… å¿…é¡» |
| **Worker æ•°é‡** | - | CPU æ ¸å¿ƒæ•° - 1 |

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šthread-loader åè€Œå˜æ…¢äº†ï¼Ÿ

**åŸå› **ï¼šWorker å¯åŠ¨å¼€é”€ > æ”¶ç›Š

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// åªåœ¨å¤§å‹é¡¹ç›®æˆ–ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
const isProd = process.env.NODE_ENV === 'production';
const moduleCount = 1000;  // å‡è®¾æ¨¡å—æ•°é‡

use: [
  // åªæœ‰æ¨¡å—æ•°é‡ > 1000 ä¸”æ˜¯ç”Ÿäº§ç¯å¢ƒæ‰ä½¿ç”¨
  (moduleCount > 1000 && isProd) && {
    loader: 'thread-loader'
  },
  'babel-loader'
].filter(Boolean)
```

---

### é—®é¢˜ 2ï¼šWorker æ•°é‡å¦‚ä½•é…ç½®ï¼Ÿ

**æ¨èé…ç½®**ï¼š

```javascript
const os = require('os');

// æ–¹å¼ 1ï¼šCPU æ ¸å¿ƒæ•° - 1ï¼ˆæ¨èï¼‰
workers: os.cpus().length - 1

// æ–¹å¼ 2ï¼šå›ºå®šæ•°é‡
workers: 4

// æ–¹å¼ 3ï¼šæ ¹æ®ç¯å¢ƒåŠ¨æ€è°ƒæ•´
workers: process.env.CI ? 2 : os.cpus().length - 1
```

**åŸåˆ™**ï¼š
- âœ… ç•™ä¸€ä¸ªæ ¸å¿ƒç»™ä¸»çº¿ç¨‹
- âœ… CI ç¯å¢ƒå¯èƒ½éœ€è¦é™åˆ¶ï¼ˆé¿å…èµ„æºç«äº‰ï¼‰

---

### é—®é¢˜ 3ï¼šå“ªäº› Loader é€‚åˆå¹¶è¡Œï¼Ÿ

**é€‚åˆ**ï¼š
```javascript
âœ… babel-loader    // JS è½¬æ¢ï¼ˆè€—æ—¶ï¼‰
âœ… ts-loader       // TS ç¼–è¯‘ï¼ˆè€—æ—¶ï¼‰
âœ… sass-loader     // Sass ç¼–è¯‘ï¼ˆè€—æ—¶ï¼‰
âœ… less-loader     // Less ç¼–è¯‘ï¼ˆè€—æ—¶ï¼‰
```

**ä¸é€‚åˆ**ï¼š
```javascript
âŒ file-loader     // æ–‡ä»¶æ‹·è´ï¼ˆå¾ˆå¿«ï¼‰
âŒ url-loader      // Base64 è½¬æ¢ï¼ˆå¾ˆå¿«ï¼‰
âŒ cache-loader    // ç¼“å­˜æ“ä½œï¼ˆIO å¯†é›†ï¼‰
âŒ eslint-loader   // ä»£ç æ£€æŸ¥ï¼ˆå·²æœ‰å¹¶è¡Œæ–¹æ¡ˆï¼‰
```

---

## ğŸ“ é¢è¯•æ”»é˜²

### é—®é¢˜ 1ï¼šthread-loader çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

```
åŸç†ï¼š
1. åˆ›å»º Worker Pool
   â””â”€ ä½¿ç”¨ Node.js çš„ worker_threads

2. ä¸»çº¿ç¨‹åˆ†å‘ä»»åŠ¡
   â””â”€ å°† Loader ä»»åŠ¡å‘é€åˆ° Worker

3. Worker å¹¶è¡Œå¤„ç†
   â””â”€ æ¯ä¸ª Worker ç‹¬ç«‹æ‰§è¡Œ Loader

4. ç»“æœè¿”å›ä¸»çº¿ç¨‹
   â””â”€ é€šè¿‡æ¶ˆæ¯é€šä¿¡è¿”å›ç»“æœ

ä¼˜åŠ¿ï¼š
  â”œâ”€ å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
  â””â”€ æå‡ 40-60% æ„å»ºé€Ÿåº¦

å¼€é”€ï¼š
  â”œâ”€ Worker å¯åŠ¨æ—¶é—´ï¼ˆ~600msï¼‰
  â”œâ”€ çº¿ç¨‹é—´é€šä¿¡æˆæœ¬
  â””â”€ å†…å­˜å ç”¨å¢åŠ 
```

---

### é—®é¢˜ 2ï¼šä½•æ—¶ä½¿ç”¨ thread-loaderï¼Ÿ

**åˆ¤æ–­æ ‡å‡†**ï¼š

```
ä½¿ç”¨æ¡ä»¶ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰ï¼š
1. å¤§å‹é¡¹ç›®
   â””â”€ æ¨¡å—æ•°é‡ > 1000

2. è€—æ—¶ Loader
   â””â”€ babel-loader, ts-loader

3. æ„å»ºæ—¶é—´é•¿
   â””â”€ æ€»æ„å»ºæ—¶é—´ > 60s

ä¸ä½¿ç”¨æ¡ä»¶ï¼š
1. å°å‹é¡¹ç›®
   â””â”€ Worker å¯åŠ¨å¼€é”€ > æ”¶ç›Š

2. å·²æœ‰ç¼“å­˜ä¼˜åŒ–
   â””â”€ ç¼“å­˜æ•ˆæœå·²ç»è¶³å¤Ÿå¥½

3. å¼€å‘ç¯å¢ƒ
   â””â”€ çƒ­æ›´æ–°æœ‰å»¶è¿Ÿ
```

**æ•°æ®æ”¯æ’‘**ï¼š
"æˆ‘ä»¬é¡¹ç›®æœ‰ 2500 ä¸ªæ¨¡å—ï¼Œbabel-loader å ç”¨ 120sï¼Œä½¿ç”¨ thread-loader åå‡å°‘åˆ° 70sï¼Œæå‡äº† 42%ã€‚"

---

### é—®é¢˜ 3ï¼šå¹¶è¡Œæ„å»ºå’Œç¼“å­˜å“ªä¸ªæ›´é‡è¦ï¼Ÿ

**ä¼˜å…ˆçº§**ï¼š

```
P0ï¼ˆæœ€é«˜ï¼‰ï¼šç¼“å­˜
  â””â”€ filesystem cache
  â””â”€ babel-loader cache
  â””â”€ æ•ˆæœï¼š-90%+ âš¡ï¸âš¡ï¸âš¡ï¸

P1ï¼ˆæ¬¡è¦ï¼‰ï¼šå¹¶è¡Œæ„å»º
  â””â”€ thread-loader
  â””â”€ TerserPlugin parallel
  â””â”€ æ•ˆæœï¼š-40-60% âš¡ï¸âš¡ï¸

ç»“è®ºï¼š
  â””â”€ ç¼“å­˜ > å¹¶è¡Œ
  â””â”€ ä½†ä¸¤è€…ç»“åˆæ•ˆæœæœ€å¥½
```

**æ¡ˆä¾‹**ï¼š

```
åªæœ‰ç¼“å­˜ï¼š
  â”œâ”€ é¦–æ¬¡ï¼š180s
  â””â”€ äºŒæ¬¡ï¼š15sï¼ˆ-92%ï¼‰

åªæœ‰å¹¶è¡Œï¼š
  â”œâ”€ é¦–æ¬¡ï¼š70sï¼ˆ-61%ï¼‰
  â””â”€ äºŒæ¬¡ï¼š70sï¼ˆæ— æå‡ï¼‰

ç¼“å­˜ + å¹¶è¡Œï¼š
  â”œâ”€ é¦–æ¬¡ï¼š70sï¼ˆ-61%ï¼‰
  â””â”€ äºŒæ¬¡ï¼š12sï¼ˆ-93%ï¼‰âš¡ï¸âš¡ï¸âš¡ï¸
```

---

## ğŸ“ å®è·µå»ºè®®

### 1. æ¸è¿›å¼ä¼˜åŒ–

```
ä¼˜åŒ–é¡ºåºï¼š
1. å¯ç”¨ç¼“å­˜ï¼ˆfilesystem cacheï¼‰
   â””â”€ æ•ˆæœæœ€å¥½ï¼Œæˆæœ¬æœ€ä½

2. æµ‹é‡æ•ˆæœ
   â””â”€ å¦‚æœäºŒæ¬¡æ„å»ºå·²ç» < 30sï¼Œå¯ä»¥ä¸ç”¨å¹¶è¡Œ

3. è€ƒè™‘å¹¶è¡Œ
   â””â”€ å¦‚æœé¦–æ¬¡æ„å»ºä»ç„¶å¾ˆæ…¢ï¼ŒåŠ ä¸Š thread-loader

4. éªŒè¯æ•ˆæœ
   â””â”€ å¯¹æ¯”å•çº¿ç¨‹ vs å¤šçº¿ç¨‹
```

### 2. é…ç½®æ¨¡æ¿

```javascript
// webpack.config.jsï¼ˆç”Ÿäº§çº§é…ç½®ï¼‰
const os = require('os');
const threadLoader = require('thread-loader');
const TerserPlugin = require('terser-webpack-plugin');

// é¢„çƒ­
threadLoader.warmup(
  { workers: os.cpus().length - 1 },
  ['babel-loader']
);

module.exports = (env, argv) => {
  const isProd = argv.mode === 'production';
  
  return {
    cache: {
      type: 'filesystem',  // â­ï¸ ä¼˜å…ˆï¼šç¼“å­˜
    },
    
    module: {
      rules: [
        {
          test: /\.js$/,
          use: [
            isProd && {  // â­ï¸ æ¬¡è¦ï¼šå¹¶è¡Œï¼ˆä»…ç”Ÿäº§ï¼‰
              loader: 'thread-loader',
              options: {
                workers: os.cpus().length - 1
              }
            },
            {
              loader: 'babel-loader',
              options: {
                cacheDirectory: true  // â­ï¸ babel ç¼“å­˜
              }
            }
          ].filter(Boolean)
        }
      ]
    },
    
    optimization: {
      minimize: isProd,
      minimizer: [
        new TerserPlugin({
          parallel: true  // â­ï¸ å¹¶è¡Œå‹ç¼©
        })
      ]
    }
  };
};
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†**å¹¶è¡Œæ„å»ºä¼˜åŒ–**ï¼š
- âœ… ç†è§£å¤šçº¿ç¨‹åŸç†
- âœ… æŒæ¡ thread-loader ä½¿ç”¨
- âœ… æŒæ¡ TerserPlugin å¹¶è¡Œå‹ç¼©
- âœ… çŸ¥é“ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ„å»º

**æ„å»ºé€Ÿåº¦æå‡ 40-60%ï¼** âš¡ï¸âš¡ï¸

**ä¸‹ä¸€æ­¥**ï¼šå­¦ä¹ é¢„ç¼–è¯‘ä¼˜åŒ– - [04-dll-externals.md](./04-dll-externals.md) ğŸš€

