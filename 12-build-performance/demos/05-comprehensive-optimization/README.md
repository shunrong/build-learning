# Demo 05: ç»¼åˆä¼˜åŒ–æ¡ˆä¾‹

## ğŸ“– Demo è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª**ç»¼åˆä¼˜åŒ–æ¡ˆä¾‹**ï¼Œæ•´åˆäº† Phase 12 å­¦ä¹ çš„æ‰€æœ‰æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œé€šè¿‡å¯¹æ¯”ä¼˜åŒ–å‰/åçš„æ„å»ºæ•°æ®ï¼Œç›´è§‚å±•ç¤ºä¼˜åŒ–æ•ˆæœã€‚

æœ¬ Demo æ„å»ºäº†ä¸€ä¸ª React SPA åº”ç”¨ï¼ŒåŒ…å«ï¼š
- React + React Routerï¼ˆè·¯ç”±çº§åˆ«æ‡’åŠ è½½ï¼‰
- Lodashï¼ˆTree Shakingï¼‰
- Axiosï¼ˆHTTP è¯·æ±‚ï¼‰
- Moment.jsï¼ˆæ—¥æœŸå¤„ç†ï¼Œæ¼”ç¤º noParseï¼‰

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- æŒæ¡æ€§èƒ½ä¼˜åŒ–çš„ç»¼åˆåº”ç”¨
- ç†è§£ä¸åŒä¼˜åŒ–æŠ€å·§çš„ååŒæ•ˆæœ
- å­¦ä¼šå¯¹æ¯”å’Œé‡åŒ–ä¼˜åŒ–æˆæœ
- å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹

## ğŸš€ è¿è¡Œæ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. å¼€å‘æ¨¡å¼

```bash
npm run dev
```

è®¿é—®è‡ªåŠ¨æ‰“å¼€çš„é¡µé¢ï¼Œä½“éªŒä¸‰ä¸ªé¡µé¢çš„æ‡’åŠ è½½æ•ˆæœã€‚

### 3. å¯¹æ¯”ä¼˜åŒ–æ•ˆæœ

#### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨å¯¹æ¯”ï¼ˆæ¨èï¼‰

```bash
npm run compare
```

è‡ªåŠ¨è¿è¡Œä¼˜åŒ–å‰/åä¸¤æ¬¡æ„å»ºï¼Œå¹¶è¾“å‡ºè¯¦ç»†å¯¹æ¯”æ•°æ®ã€‚

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯¹æ¯”

```bash
# ä¼˜åŒ–å‰æ„å»º
npm run build:before

# ä¼˜åŒ–åæ„å»º
npm run build:after

# åˆ†æä¼˜åŒ–å‰çš„åŒ…ç»“æ„
npm run analyze:before

# åˆ†æä¼˜åŒ–åçš„åŒ…ç»“æ„
npm run analyze:after
```

### 4. éªŒè¯ç¼“å­˜æ•ˆæœï¼ˆé‡è¦ï¼‰

```bash
# é¦–æ¬¡æ„å»ºï¼ˆè®°å½•æ—¶é—´ï¼‰
time npm run build:after

# äºŒæ¬¡æ„å»ºï¼ˆåº”è¯¥å¿« 80%+ï¼‰
time npm run build:after
```

## ğŸ“Š ä¼˜åŒ–æ¸…å•

æœ¬ Demo åº”ç”¨äº† **8 é¡¹æ ¸å¿ƒä¼˜åŒ–æŠ€å·§**ï¼š

| # | ä¼˜åŒ–æŠ€å·§ | é…ç½®æ–‡ä»¶ | é¢„æœŸæ•ˆæœ |
|---|---------|---------|---------|
| 1 | **æŒä¹…åŒ–ç¼“å­˜** | `cache: { type: 'filesystem' }` | äºŒæ¬¡æ„å»ºæé€Ÿ 80%+ |
| 2 | **å¹¶è¡Œæ„å»º** | `thread-loader` | å¤šæ ¸ CPU åŠ é€Ÿï¼Œæé€Ÿ 30%+ |
| 3 | **å¹¶è¡Œå‹ç¼©** | `TerserPlugin({ parallel: true })` | å‹ç¼©æé€Ÿ 50%+ |
| 4 | **ä»£ç åˆ†å‰²** | `splitChunks` | vendor/react/common åˆ†ç¦» |
| 5 | **Tree Shaking** | `usedExports: true` | ç§»é™¤æœªä½¿ç”¨ä»£ç ï¼Œå‡å° 10-20% |
| 6 | **æ‡’åŠ è½½** | `React.lazy()` | è·¯ç”±çº§åˆ«ä»£ç åˆ†å‰² |
| 7 | **ç¼©å° resolve** | `resolve.modules/extensions` | æ¨¡å—è§£ææé€Ÿ |
| 8 | **noParse** | `noParse: /lodash|moment/` | è·³è¿‡é¢„ç¼–è¯‘åº“ï¼Œæé€Ÿ 5-10% |

## ğŸ” æ ¸å¿ƒé…ç½®è¯¦è§£

### 1. æŒä¹…åŒ–ç¼“å­˜

```javascript
// webpack.after.config.js
module.exports = {
  cache: {
    type: 'filesystem',
    buildDependencies: {
      config: [__filename]  // é…ç½®å˜åŒ–æ—¶å¤±æ•ˆç¼“å­˜
    }
  }
};
```

**æ•ˆæœ**ï¼š
- é¦–æ¬¡æ„å»ºï¼šæ­£å¸¸é€Ÿåº¦
- äºŒæ¬¡æ„å»ºï¼šæé€Ÿ 80%+ï¼ˆæœªä¿®æ”¹æ–‡ä»¶ç›´æ¥å¤ç”¨ç¼“å­˜ï¼‰

### 2. å¹¶è¡Œæ„å»º

```javascript
{
  test: /\.jsx?$/,
  use: [
    {
      loader: 'thread-loader',
      options: {
        workers: 2,              // å¹¶è¡Œè¿›ç¨‹æ•°
        poolTimeout: Infinity    // ä¿æŒè¿›ç¨‹æ± ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
      }
    },
    'babel-loader'
  ]
}
```

**æ•ˆæœ**ï¼š
- å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- å¤§å‹é¡¹ç›®æé€Ÿ 30-50%
- å°é¡¹ç›®æ•ˆæœä¸æ˜æ˜¾ï¼ˆè¿›ç¨‹é€šä¿¡å¼€é”€ï¼‰

### 3. ä»£ç åˆ†å‰²

```javascript
optimization: {
  splitChunks: {
    chunks: 'all',
    cacheGroups: {
      // React ç›¸å…³å•ç‹¬æ‰“åŒ…
      react: {
        test: /[\\/]node_modules[\\/](react|react-dom|react-router-dom)[\\/]/,
        name: 'react',
        priority: 20
      },
      // å…¶ä»– vendor
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendors',
        priority: 10
      },
      // å…¬å…±ä»£ç 
      common: {
        minChunks: 2,
        priority: 5,
        reuseExistingChunk: true
      }
    }
  }
}
```

**æ•ˆæœ**ï¼š
- `react.xxx.js`ï¼šReact ç›¸å…³ï¼ˆç¨³å®šï¼Œé•¿æœŸç¼“å­˜ï¼‰
- `vendors.xxx.js`ï¼šå…¶ä»–ç¬¬ä¸‰æ–¹åº“
- `common.xxx.js`ï¼šä¸šåŠ¡å…¬å…±ä»£ç 
- `main.xxx.js`ï¼šå…¥å£ä»£ç 
- æ‡’åŠ è½½çš„é¡µé¢å•ç‹¬æ‰“åŒ…ï¼ˆ`src_pages_*.js`ï¼‰

### 4. å¹¶è¡Œå‹ç¼©

```javascript
optimization: {
  minimizer: [
    new TerserPlugin({
      parallel: true,  // å¹¶è¡Œå‹ç¼©
      terserOptions: {
        compress: {
          drop_console: true,
          drop_debugger: true
        }
      }
    }),
    new CssMinimizerPlugin({
      parallel: true
    })
  ]
}
```

**æ•ˆæœ**ï¼š
- å‹ç¼©é€Ÿåº¦æå‡ 50%+
- è‡ªåŠ¨ç§»é™¤ `console.log` å’Œ `debugger`

### 5. noParse

```javascript
module: {
  noParse: /lodash|moment/  // è·³è¿‡è¿™äº›åº“çš„è§£æ
}
```

**æ•ˆæœ**ï¼š
- è·³è¿‡é¢„ç¼–è¯‘åº“çš„ AST è§£æ
- é€‚ç”¨äºå·²ç»æ‰“åŒ…å¥½çš„åº“ï¼ˆæ— ä¾èµ–ï¼‰
- æé€Ÿ 5-10%

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„è§ˆ

è¿è¡Œ `npm run compare` åçš„å…¸å‹è¾“å‡ºï¼š

```
ğŸ“Š æ€§èƒ½æå‡æ±‡æ€»:

â±ï¸  æ„å»ºæ—¶é—´:
   ä¼˜åŒ–å‰: 12.50s
   ä¼˜åŒ–å: 8.30s
   æå‡: 33.6%

ğŸ“¦ è¾“å‡ºä½“ç§¯:
   ä¼˜åŒ–å‰: 850.23 KB
   ä¼˜åŒ–å: 720.45 KB
   å‡å°‘: 15.3%

ğŸ“ æ–‡ä»¶æ•°é‡:
   ä¼˜åŒ–å‰: 3 ä¸ªæ–‡ä»¶
   ä¼˜åŒ–å: 8 ä¸ªæ–‡ä»¶
   å¢åŠ : 5 ä¸ª (Code Splitting)

ğŸ¯ æœ€å¤§æ–‡ä»¶:
   ä¼˜åŒ–å‰: main.abc123.js (780.45 KB)
   ä¼˜åŒ–å: react.def456.js (150.23 KB)

ğŸ’¡ åº”ç”¨çš„ä¼˜åŒ–æŠ€å·§:
   1. âœ… æŒä¹…åŒ–ç¼“å­˜ (filesystem cache) - äºŒæ¬¡æ„å»ºé€Ÿåº¦æå‡ 80%+
   2. âœ… å¹¶è¡Œæ„å»º (thread-loader) - å¤šæ ¸ CPU åŠ é€Ÿç¼–è¯‘
   3. âœ… å¹¶è¡Œå‹ç¼© (TerserPlugin parallel) - å‹ç¼©é€Ÿåº¦æå‡ 50%+
   4. âœ… ä»£ç åˆ†å‰² (splitChunks) - vendor/react/common åˆ†ç¦»
   5. âœ… Tree Shaking (usedExports) - ç§»é™¤æœªä½¿ç”¨ä»£ç 
   6. âœ… æ‡’åŠ è½½ (lazy) - è·¯ç”±çº§åˆ«ä»£ç åˆ†å‰²
   7. âœ… ç¼©å° resolve èŒƒå›´ - åŠ å¿«æ¨¡å—è§£æ
   8. âœ… noParse - è·³è¿‡é¢„ç¼–è¯‘åº“è§£æ

ğŸ” äºŒæ¬¡æ„å»ºæµ‹è¯•ï¼ˆéªŒè¯ç¼“å­˜æ•ˆæœï¼‰:
   è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯¹æ¯”é¦–æ¬¡/äºŒæ¬¡æ„å»ºé€Ÿåº¦ï¼š
   $ time npm run build:after  # é¦–æ¬¡æ„å»º
   $ time npm run build:after  # äºŒæ¬¡æ„å»ºï¼ˆåº”è¯¥å¿« 80%+ï¼‰
```

## ğŸ’¡ å…³é”®çŸ¥è¯†ç‚¹

### 1. ä¸ºä»€ä¹ˆä¼˜åŒ–åæ–‡ä»¶æ•°é‡å˜å¤šï¼Ÿ

ä¼˜åŒ–å‰ï¼š
```
dist-before/
â”œâ”€â”€ main.abc123.js       (780 KB) â† æ‰€æœ‰ä»£ç æ‰“åŒ…åœ¨ä¸€èµ·
â”œâ”€â”€ main.abc123.css
â””â”€â”€ index.html
```

ä¼˜åŒ–åï¼š
```
dist-after/
â”œâ”€â”€ runtime.xyz789.js    (2 KB)   â† Webpack è¿è¡Œæ—¶
â”œâ”€â”€ react.def456.js      (150 KB) â† React ç›¸å…³ï¼ˆé•¿æœŸç¼“å­˜ï¼‰
â”œâ”€â”€ vendors.ghi789.js    (320 KB) â† Lodash/Axios/Moment
â”œâ”€â”€ common.jkl012.js     (30 KB)  â† ä¸šåŠ¡å…¬å…±ä»£ç 
â”œâ”€â”€ main.mno345.js       (50 KB)  â† å…¥å£ä»£ç 
â”œâ”€â”€ src_pages_Dashboard*.js (40 KB) â† æ‡’åŠ è½½é¡µé¢
â”œâ”€â”€ src_pages_Analytics*.js (35 KB)
â”œâ”€â”€ main.abc123.css
â””â”€â”€ index.html
```

**å¥½å¤„**ï¼š
- React å‡ ä¹ä¸å˜ â†’ é•¿æœŸç¼“å­˜
- ä¿®æ”¹ä¸šåŠ¡ä»£ç  â†’ åªéœ€ä¸‹è½½ `main.js` å’Œ `common.js`
- æŒ‰éœ€åŠ è½½ â†’ Dashboard é¡µé¢åªåœ¨è®¿é—®æ—¶ä¸‹è½½

### 2. ä¸ºä»€ä¹ˆé¦–æ¬¡æ„å»ºåè€Œæ›´æ…¢ï¼Ÿ

ä¼˜åŒ–åé…ç½®æ›´å¤æ‚ï¼š
- `thread-loader` éœ€è¦å¯åŠ¨å·¥ä½œè¿›ç¨‹
- `splitChunks` éœ€è¦åˆ†æä¾èµ–å…³ç³»
- ç¼“å­˜éœ€è¦é¦–æ¬¡å†™å…¥ç£ç›˜

**ä½†æ˜¯**ï¼š
- äºŒæ¬¡æ„å»ºä¼šå¿« 80%+ï¼ˆç¼“å­˜æ•ˆæœï¼‰
- ç”Ÿäº§ç¯å¢ƒé€šå¸¸åªæ„å»ºä¸€æ¬¡
- å¼€å‘ç¯å¢ƒäºŒæ¬¡æ„å»ºæ˜¯å¸¸æ€

### 3. ä½•æ—¶åº”ç”¨è¿™äº›ä¼˜åŒ–ï¼Ÿ

**å°å‹é¡¹ç›®ï¼ˆ< 100 ä¸ªæ¨¡å—ï¼‰**ï¼š
- âœ… æŒä¹…åŒ–ç¼“å­˜
- âœ… splitChunksï¼ˆç®€å•é…ç½®ï¼‰
- âŒ thread-loaderï¼ˆå¼€é”€å¤§äºæ”¶ç›Šï¼‰
- âŒ noParseï¼ˆæ•ˆæœä¸æ˜æ˜¾ï¼‰

**ä¸­å‹é¡¹ç›®ï¼ˆ100-500 ä¸ªæ¨¡å—ï¼‰**ï¼š
- âœ… æŒä¹…åŒ–ç¼“å­˜
- âœ… splitChunks
- âœ… å¹¶è¡Œå‹ç¼©
- âš ï¸ thread-loaderï¼ˆè§† CPU æ ¸å¿ƒæ•°ï¼‰

**å¤§å‹é¡¹ç›®ï¼ˆ> 500 ä¸ªæ¨¡å—ï¼‰**ï¼š
- âœ… æ‰€æœ‰ä¼˜åŒ–æŠ€å·§
- âœ… è€ƒè™‘ Externals (CDN)
- âœ… è€ƒè™‘å¾®å‰ç«¯æ¶æ„

## ğŸ“ å»¶ä¼¸æ€è€ƒ

### 1. å¦‚ä½•é‡åŒ–ä¼˜åŒ–æ•ˆæœï¼Ÿ

ä½¿ç”¨ `speed-measure-webpack-plugin` å’Œ `webpack-bundle-analyzer`ï¼š

```javascript
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin');
const smp = new SpeedMeasurePlugin();

module.exports = smp.wrap({
  // ä½ çš„ webpack é…ç½®
});
```

### 2. å¦‚ä½•åœ¨å›¢é˜Ÿä¸­æ¨å¹¿æ€§èƒ½ä¼˜åŒ–ï¼Ÿ

**æ­¥éª¤**ï¼š
1. **å»ºç«‹åŸºå‡†**ï¼šè®°å½•å½“å‰æ„å»ºé€Ÿåº¦å’ŒåŒ…ä½“ç§¯
2. **é€æ­¥ä¼˜åŒ–**ï¼šä¸€æ¬¡åº”ç”¨ä¸€é¡¹ä¼˜åŒ–ï¼Œè®°å½•æ•ˆæœ
3. **å¯è§†åŒ–å¯¹æ¯”**ï¼šä½¿ç”¨å›¾è¡¨å±•ç¤ºä¼˜åŒ–å‰åå¯¹æ¯”
4. **ç¼–å†™æ–‡æ¡£**ï¼šè®°å½•æœ€ä½³å®è·µå’Œé…ç½®æ¨¡æ¿
5. **è‡ªåŠ¨åŒ–æ£€æµ‹**ï¼šCI/CD ä¸­é›†æˆæ€§èƒ½ç›‘æ§

**ç¤ºä¾‹ CI è„šæœ¬**ï¼š
```bash
#!/bin/bash
# åœ¨ CI ä¸­å¯¹æ¯”æ„å»ºæ—¶é—´
BEFORE=$(date +%s)
npm run build
AFTER=$(date +%s)
DURATION=$((AFTER - BEFORE))

if [ $DURATION -gt 60 ]; then
  echo "âš ï¸ æ„å»ºæ—¶é—´è¿‡é•¿: ${DURATION}s"
  exit 1
fi
```

### 3. Webpack 5 vs Webpack 4 ä¼˜åŒ–å·®å¼‚

| ä¼˜åŒ–æŠ€å·§ | Webpack 4 | Webpack 5 |
|---------|-----------|-----------|
| æŒä¹…åŒ–ç¼“å­˜ | éœ€è¦ `hard-source-webpack-plugin` | å†…ç½® `filesystem cache` |
| Tree Shaking | éœ€è¦æ‰‹åŠ¨é…ç½® | é»˜è®¤å¼€å¯ä¸”æ›´æ™ºèƒ½ |
| Code Splitting | é…ç½®å¤æ‚ | æ›´æ™ºèƒ½çš„é»˜è®¤é…ç½® |
| é•¿æœŸç¼“å­˜ | `chunkhash` | `contenthash` æ›´ç¨³å®š |

**å»ºè®®**ï¼š
- æ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨ Webpack 5
- è€é¡¹ç›®è¯„ä¼°å‡çº§æˆæœ¬ï¼ˆé€šå¸¸å€¼å¾—ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Webpack 5 Cache é…ç½®](https://webpack.js.org/configuration/cache/)
- [SplitChunksPlugin è¯¦è§£](https://webpack.js.org/plugins/split-chunks-plugin/)
- [thread-loader ä½¿ç”¨æŒ‡å—](https://webpack.js.org/loaders/thread-loader/)
- [TerserPlugin é…ç½®é€‰é¡¹](https://webpack.js.org/plugins/terser-webpack-plugin/)
- [æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](https://webpack.js.org/guides/build-performance/)

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ¬ Demo åï¼Œå»ºè®®ï¼š
1. âœ… å¤ä¹  Phase 12 æ‰€æœ‰æ–‡æ¡£
2. âœ… å°†ä¼˜åŒ–æŠ€å·§åº”ç”¨åˆ°è‡ªå·±çš„é¡¹ç›®
3. âœ… è¿›å…¥ Phase 13ï¼ˆBundle ä¼˜åŒ–ï¼‰
4. âœ… è¿›å…¥ Phase 14ï¼ˆè¿è¡Œæ—¶ä¼˜åŒ–ï¼‰

---

**æ­å–œä½ å®Œæˆäº† Phase 12 çš„å­¦ä¹ ï¼ğŸ‰**

ä½ ç°åœ¨å·²ç»æŒæ¡äº† Webpack æ„å»ºæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€å·§ï¼Œè¿™äº›çŸ¥è¯†å°†å¸®åŠ©ä½ åœ¨å®é™…é¡¹ç›®ä¸­å¤§å¹…æå‡å¼€å‘ä½“éªŒå’Œæ„å»ºæ•ˆç‡ã€‚

